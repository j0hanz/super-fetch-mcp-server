# AGENTS.md

## Project Overview

- This repo is an MCP (Model Context Protocol) server that fetches web pages, extracts readable content, and converts it to AI-friendly Markdown.
- Language/runtime: TypeScript (ESM, NodeNext) on Node.js `>=20.12.0`.
- Entry point / CLI: `src/index.ts` (built to `dist/index.js`, bin name: `superfetch`).
- Modes:
  - **stdio**: `node dist/index.js --stdio`
  - **HTTP** (default): starts an Express server (auth required in HTTP mode)

## Repo Map / Structure

- `src/`: production source
  - `src/index.ts`: CLI entry; selects stdio vs HTTP mode
  - `src/server.ts`: MCP server wired to stdio transport
  - `src/http/`: HTTP server, MCP routes, sessions, auth, downloads
  - `src/tools/`: MCP tool definitions and handlers (e.g., `fetch-url`)
  - `src/transformers/`: HTML → Markdown transformation
  - `src/services/`: fetch pipeline, caching, logging, extraction helpers
  - `src/config/`: env parsing and runtime configuration
  - `src/utils/`: shared utilities (URL validation, truncation, crypto, etc.)
- `tests/`: Node.js built-in test runner tests (`node --test`)
- `docs/`: project assets (logo)
- `scripts/Quality-Gates.ps1`: repo-specific quality/metrics helper
- `dist/`: build output (generated by `npm run build`; not committed)

## Setup & Environment

- Required: Node.js `>=20.12.0`.
- Package manager: npm (repo includes `package-lock.json`; CI uses `npm ci`).
- Install dependencies:
  - `npm ci` (recommended for clean installs)
  - `npm install` (local development)
- Configuration:
  - Environment variables are the primary config mechanism.
  - Reference: `CONFIGURATION.md` (authoritative list of env vars and presets).

## Development Workflow

- Dev (watch mode): `npm run dev`
  - Runs `tsx watch src/index.ts`.
- Build: `npm run build`
  - Compiles with `tsc -p tsconfig.build.json` and then runs a small Node script to `chmod` `dist/index.js`.
- Run from build:
  - stdio mode: `node dist/index.js --stdio`
  - HTTP mode: `npm start`
  - Pass args through npm: `npm start -- --stdio`

## Testing

- All tests: `npm test`
  - Runs `npm run build --silent` then `node --test --experimental-transform-types`.
  - Expect a Node experimental warning due to `--experimental-transform-types`.
- Coverage: `npm run test:coverage`
- Test location: `tests/` (TypeScript `.ts` tests executed by Node with experimental transform).

## Code Style & Conventions

- TypeScript configuration: `tsconfig.json` is strict (includes `exactOptionalPropertyTypes`, `noUncheckedIndexedAccess`).
- ESM/NodeNext import convention:
  - Local imports use `.js` extensions (e.g., `import { x } from './x.js'`).
- Lint:
  - `npm run lint` (`eslint .`)
  - ESLint is configured in `eslint.config.mjs` and uses type-aware `typescript-eslint` configs.
- Format:
  - `npm run format` (Prettier)
  - Prettier configuration is in `.prettierrc` and includes `@trivago/prettier-plugin-sort-imports` with a defined `importOrder`.
- Common conventions enforced by linting/config:
  - Prefer `import type` for type-only imports.
  - Prefer named exports (repo patterns follow named exports).
  - Keep exported functions explicitly typed (ESLint rules enforce explicit return types).

## Build / Release

- Build output: `dist/`.
- Prepublish gate: `npm run prepublishOnly` runs `lint`, `type-check`, then `build`.
- GitHub Actions:
  - Tag push `v*.*.*` triggers a release automation workflow that builds, lints, type-checks, publishes, and creates a GitHub Release.
  - Publishing can also run on GitHub Releases (Trusted Publishing/OIDC).

## Security & Safety

- This server fetches arbitrary URLs on behalf of a client; treat all inputs as untrusted.
- URL/SSRF protections (documented in `README.md` and enforced in code):
  - Only `http`/`https` URLs
  - Reject embedded credentials in URLs
  - DNS resolution + blocked private/metadata ranges and internal suffixes
- HTTP mode safety:
  - Authentication is required (static tokens and/or OAuth; see `CONFIGURATION.md`).
  - Host/Origin validation is enforced for HTTP requests.
- Secrets:
  - Use environment variables (do not commit tokens).
  - Never log secrets (check structured logs in `src/services/logger.ts` when changing auth).

## Pull Request / Commit Guidelines

- No repository-specific PR template or commit-message linting config was found.
- Follow the workflow in `README.md` under “Contributing”:
  - Run `npm run lint`
  - Run `npm test`
  - Open a PR with a clear description and any security implications (especially for URL validation / SSRF).

## Troubleshooting

- Tests emit an experimental warning:
  - Expected: `node --test --experimental-transform-types` is used to execute TypeScript test files.
- Windows + `npx` MCP client integration:
  - If stdio launch via `npx` has issues, `README.md` suggests using `cmd /c "npx -y @j0hanz/superfetch@latest --stdio"`.
- HTTP mode fails to start:
  - Ensure auth is configured (static token(s) or OAuth). See `CONFIGURATION.md`.

## Open Questions / TODO

- `.github/workflows/release.yml` references `server.json` (reads and rewrites it), but no `server.json` file exists in this repository snapshot. Decide whether to add/restore it or update the workflow.
