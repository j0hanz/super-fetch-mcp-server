# AGENTS.md

## Project Overview

- **Package**: `@j0hanz/superfetch` (MCP server ID: `io.github.j0hanz/superfetch`)
- **Purpose**: MCP server that fetches web pages, extracts readable content via Mozilla Readability, and returns AI-friendly Markdown
- **Stack**: TypeScript 5.9, Node.js >=20.12, Express 5, MCP SDK, Zod 4
- **License**: MIT

## Repo Map / Structure

- `src/` — TypeScript source (entry: `index.ts`, `server.ts`)
  - `config/` — Constants, formatting, runtime/tool types
  - `errors/` — Custom `AppError` class
  - `http/` — Express routes, sessions, CORS, rate limiting
  - `middleware/` — Express error handler
  - `resources/` — MCP resource handlers (cache, health, stats)
  - `services/` — Core logic (cache, fetcher, extractor, parser, logger)
  - `tools/` — MCP tool definitions, schemas, handlers
  - `transformers/` — JSONL and Markdown transformers
  - `utils/` — URL validation, sanitization, crypto, helpers
  - `workers/` — (reserved for worker threads)
- `dist/` — Build output (gitignored, generated by `npm run build`)
- `tests/` — Node.js native test runner tests (`*.test.ts`)
- `scripts/` — Release and benchmark utilities
- `docs/` — Reference docs (Node API notes)
- `.github/workflows/` — CI: `release.yml`, `publish.yml`
- `CONFIGURATION.md` — Full env var reference

## Setup & Environment

- **Install deps**: `npm install` (or `npm ci` for CI)
- **Node version**: >=20.12 (see `engines` in `package.json`)
- **Env config**: See `CONFIGURATION.md` for all env vars and presets
- **No external services required** for stdio mode; HTTP mode requires `API_KEY`

## Development Workflow

- **Dev mode**: `npm run dev` (tsx watch, hot reload)
- **Build**: `npm run build` (compiles to `dist/`)
- **Start (prod)**: `npm start` (runs `node dist/index.js`)
- **Format**: `npm run format` (Prettier)
- **Lint**: `npm run lint` (ESLint with strict TS rules)
- **Lint + fix**: `npm run lint:fix`
- **Type-check**: `npm run type-check` (tsc --noEmit)

## Testing

- **All tests**: `npm test` (builds first, then `node --test --experimental-transform-types`)
- **Coverage**: `npm run test:coverage`
- **Test locations**: `tests/*.test.ts`
- **Test runner**: Node.js native test runner (emits experimental warning)
- **Benchmark**: `npm run bench`

## Code Style & Conventions

- **Language**: TypeScript 5.9 (strict mode, `noUncheckedIndexedAccess`, `exactOptionalPropertyTypes`)
- **Target**: ES2022, module: NodeNext
- **Lint**: ESLint 9 with `typescript-eslint` strict + stylistic presets
- **Format**: Prettier (with `@trivago/prettier-plugin-sort-imports`)
- **Naming**:
  - Variables/functions: `camelCase`
  - Types/classes: `PascalCase`
  - Constants: `UPPER_CASE` or `camelCase`
  - Files: `kebab-case.ts`
- **Imports**: Use type imports (`import type { X }`) per ESLint rule
- **Unused code**: Run `npm run knip` to detect; `npm run knip:fix` to auto-remove

## Build / Release

- **Build output**: `dist/` (compiled JS + declarations)
- **Release process**:
  1. Run `npm run release` (interactive script)
  2. Script updates `package.json` version and pushes a `v*.*.*` tag
  3. CI (`release.yml`) validates lint/type-check/build and publishes to npm
- **Published files**: `dist/`, `README.md` (see `files` in `package.json`)

## Security & Safety

- **SSRF protection**: Blocks private IPs, link-local, cloud metadata endpoints
- **URL validation**: Only `http`/`https`, no embedded credentials, max 2048 chars
- **Header sanitization**: Blocks `host`, `authorization`, `cookie`, `x-forwarded-for`, etc.
- **HTTP mode**: Requires `API_KEY`; binds to loopback by default; set `ALLOW_REMOTE=true` for non-loopback
- **Rate limiting**: Enabled by default in HTTP mode (configurable)
- **No secrets in code**: Use env vars for sensitive config

## Pull Request / Commit Guidelines

- **Commit format**: Conventional commits encouraged (e.g., `feat: add X`, `fix: resolve Y`)
- **Required checks** (CI enforces):
  - `npm run lint`
  - `npm run type-check`
  - `npm run build`
- **PR workflow**:
  1. Fork and create feature branch: `git checkout -b feature/amazing-feature`
  2. Ensure lint/type-check/build pass locally
  3. Run tests: `npm test`
  4. Push and open PR

## Troubleshooting

- **Windows `npx` issues**: Use `cmd /c "npx -y @j0hanz/superfetch@latest --stdio"`
- **Experimental warning in tests**: Expected; Node.js native test runner with `--experimental-transform-types`
- **Build fails**: Ensure Node >=20.12; run `npm run type-check` to see TS errors
- **Lint errors**: Run `npm run lint:fix` for auto-fixable issues
- **Unused exports**: Run `npm run knip` to identify dead code

## Agent Operating Rules

1. **Search before edit**: Use grep/semantic search to understand context before modifying code
2. **Read docs first**: Check `README.md` and `CONFIGURATION.md` before changing behavior
3. **Avoid destructive commands**: No `rm -rf`, no force pushes, no dropping tables
4. **Preserve type safety**: Never use `any`; follow strict TS config
5. **Run checks after changes**: `npm run lint && npm run type-check && npm run build`
6. **Test changes**: Run `npm test` to verify no regressions
